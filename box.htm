<!DOCTYPE>
<head>
<meta charset="UTF-8"><title>数据获取工具</title>

<meta name="viewport" content="width=device-width,height=device-height,user-scalable=yes,initial-scale=1,minimum-scale=1,maximum-scale=2">
<meta name="format-detection" content="telphone=no, email=no"/>
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="full-screen" content="yes">
<meta name="x5-fullscreen" content="true">
<meta name="browsermode" content="application">
<html lang="zh-cn">
<meta name="description" content="数据获取工具"/>
<meta name="keywords" content="数据获取工具"/>
<meta name="Tony" contect="tony, tonylianlong@tonylianlong.com" />
<link rel="shortcut icon" type="image/ico" href="/favicon.ico"/>
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="./img/logo-57.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="./img/logo-72.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="./img/logo-114.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="./img/logo-144.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="./img/logo-152.png">
<link rel="apple-touch-icon-precomposed" sizes="196x196" href="./img/logo-196.png">
<link rel="apple-touch-startup-image" sizes="2048x1496" href="./img/startup-2048x1496.png" media="screen and (min-device-width:481px) and (max-device-width:1024px) and (orientation:landscape) and (-webkit-min-device-pixel-ratio: 2)">
<link rel="apple-touch-startup-image" sizes="1536x2008" href="./img/startup-1536x2008.png" media="screen and (min-device-width:481px) and (max-device-width:1024px) and (orientation:portrait) and (-webkit-min-device-pixel-ratio: 2)">
<link rel="apple-touch-startup-image" sizes="1024x748" href="./img/startup-1024x748.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)">
<link rel="apple-touch-startup-image" sizes="768x1004" href="./img/startup-768x1004.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)">
<link rel="apple-touch-startup-image" sizes="640x920" href="./img/startup-640x920.png" media="screen and (max-device-width: 480px) and (-webkit-min-device-pixel-ratio: 2)">
<link rel="apple-touch-startup-image" sizes="320x460" href="./img/startup-320x460.png" media="screen and (max-device-width: 320)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#000"/>
<meta name="msapplication-TileImage" content="icon.png"/>
<meta name="msapplication-tap-highlight" content="no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="空气状态显示">

<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">   
<script src="./js/jquery.js"></script>
<script src="./js/js.cookie.js"></script>
<script src="./js/initialize.js"></script>
<script src="./js/highcharts.js"></script>
<script src="./js/exporting.js"></script>
<link rel="stylesheet" type="text/css" href="./style/jquery.mobile-1.4.5.min.css"></link>
<script src="./js/jquery.mobile-1.4.5.min.js"></script>
<script>
var info;
var info2;
</script>
</head>
<body style='font-family:微软雅黑,"Microsoft YaHei"'>
<div data-role="header" role="banner" class="ui-header ui-bar-inherit">
<h1 class="ui-title" role="heading" aria-level="1">状态显示</h1>
	<button id="home-button" class="show1 ui-btn-left ui-btn ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-home">主页</button>
	<button id="center-button" class="show1 ui-btn-left ui-btn ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-home">用户中心</button>
	<button id="option-button" class="show1 ui-btn-right ui-btn ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-grid">功能</button>
	<button id="save-button" class="show2 ui-btn-right ui-btn ui-btn-b ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-check">返回</button>
</div>
<div class="show1" id="show1_div">
	<!--<div data-role="tabs" id="tabs">
	  <div id="navbar" data-role="navbar">
		<ul>
		  <li><a number="0" class="navbar0item" data-ajax="false">PM2.5</a></li>
		  <li><a number="1" class="navbar0item" data-ajax="false">VOC</a></li>
		  <li><a number="2" class="navbar0item" data-ajax="false">温度</a></li>
		  <li><a number="3" class="navbar0item" data-ajax="false">湿度</a></li>
		</ul>
	  </div>
	</div>-->
</div>
<div class="show2">
	<div data-role="tabs" id="tabs2">
	  <div id="navbar2" data-role="navbar">
		<ul>
		  <li><a href="#item2-0" data-ajax="false">实用</a></li>
		  <li><a href="#item2-1" data-ajax="false">设置</a></li>
		</ul>
		<div id="item2-0" class="ui-body-d ui-content">
			<h1>实用</h1>
			<button id="download_table">下载表格</button>
			<textarea id="boxstatustext" name="boxstatustext" readonly="readonly">盒子信息</textarea>
			<button id="follow">关注</button>
			<label for="bname-text" class="bname">备注名称：</label>
    		<input type="text" name="bname-text" id="bname-text" class="bname" value="">
			<button id="edit-bname" class="bname">修改备注</button>
			<!--<button id="empty_data">清空数据</button>
			<textarea id="statustext" name="statustext" readonly="readonly">未获取状态</textarea>
			<button id="get_status">获取状态</button>
			<button id="get_preferences">获取偏好</button>-->
			<script>$(document).ready(function(){
						$("#edit-bname").click(function(){
							console.log($("#bname-text").val());
							$.ajax({ 
								type:"GET", 
								url:"user.php", 
								dataType:"json", 
								data:{command:"edit-bname",box_code:box_code,box_bname:$("#bname-text").val(),box_password:box_password},
								cache:false,
								success:function(result){
									console.log(result);
									if(result.result == "success"){
										alert('修改成功');
										info.box_bname = $("#bname-text").val();
										if(info.box_bname && (info.box_bname != "")){
											$(".ui-title").text(info.box_bname+"状态显示");
										}else if(info.box_name){
											$(".ui-title").text(info.box_name+"状态显示");
										}else{
											$(".ui-title").text("状态显示");
										}
									}else{
										alert('修改失败，原因：'+result.result); 
									}
								},
								failure:function (result) { 
									alert('修改失败，网络连接可能有问题。'); 
								}
							});
						});
						$("#follow").click(function(){
							if(followed){
								$.ajax({ 
									type:"GET", 
									url:"user.php", 
									dataType:"json", 
									data:{command:"unfollow",box_code:box_code,box_password:box_password},
									cache:false,
									success:function(result){
										console.log(result);
										/*result_data = jQuery.parseJSON(result);
										console.log(result_data);*/
										if(result.result == "success"){
											alert('取消关注成功');
											followed = false;
											$("#follow").html("关注");
											$(".bname").hide();
											$("#bname-text").parent(".ui-input-text").hide();
										}else if(result.result == "followed"){
											alert('已取消关注');
											followed = false;
											$("#follow").html("关注");
											$(".bname").hide();
											$("#bname-text").parent(".ui-input-text").hide();//For JQ Mobile
										}else{
											alert('取消关注失败 '+result.result); 
										}
									},
									failure:function (result) { 
										alert('取消关注失败，网络连接可能有问题。'); 
									}
								});
							}else{
								$.ajax({ 
									type:"GET", 
									url:"user.php", 
									dataType:"json", 
									data:{command:"follow",box_code:box_code,box_password:box_password},
									cache:false,
									success:function(result){
										console.log(result);
										/*result_data = jQuery.parseJSON(result);
										console.log(result_data);*/
										if(result.result == "success"){
											alert('关注成功');
											followed = true;
											$("#follow").html("取消关注");
											$(".bname").show();
											$("#bname-text").parent(".ui-input-text").show();
											$("#bname-text").val(result.bname);
										}else if(result.result == "followed"){
											alert('已关注');
											followed = true;
											$("#follow").html("取消关注");
											$(".bname").show();
											$("#bname-text").parent(".ui-input-text").show();
											$("#bname-text").val(result.bname);
										}else{
											alert('关注失败 '+result.result); 
										}
									},
									failure:function (result) { 
										alert('关注失败，网络连接可能有问题。'); 
									}
								});
							}
						});
						
						$("#download_table").click(function(){
							//if(!mobile){
								var aLink = document.createElement('a');
								/*table_data = "传感器数据"+"\r\n名称,时间,数值\r\n";
								for(var i = 0;i < data.length;i++){
									for(k in data[i][0]){
										table_data += sensor_name[k]+","+data[i][1]+","+data[i][0][k]+"\r\n"
									}
								}*/
								all_sensor_name = "";
								for(var i = 0;i<datatype.length;i++){
									all_sensor_name+=sensor_name[datatype[i]];
									if(i != datatype.length-1){
										all_sensor_name+=",";
									}
								}
								table_data = "传感器数据"+"\r\n时间,"+all_sensor_name+"\r\n";
								for(var i = 0;i < data.length;i++){
									//for(k in data[i][0]){
									table_data += data[i][1];
									for(var j = 0;j < datatype.length;j++){
										table_data += ","+data[i][0][datatype[j]];
									}
									table_data+="\r\n";
								}
								str =  encodeURIComponent("\ufeff"+table_data);  
								aLink.download = "DataTable.csv";
								aLink.href = "data:text/csv;charset=utf-8,\ufeff"+str;  
								aLink.click();
								//downloadFile("Table"+String(n+1)+".csv",'77u/'+$.base64.atob(table_data, true));
							/*}else{
								alert("移动设备不支持下载表格。");
							}*/
						});
				});
			</script>
		</div>
		<div id="item2-1" class="ui-body-d ui-content">
			<!--<h1>信息获取设置</h1>
			<label for="getperiod">信息获取间隔：</label>
     		<input type="text" name="getperiod" id="getperiod" value="30">
			<label for="getperiod">单位：秒</label>
			<label>
		        <input type="checkbox" name="uploaddata" checked="checked" id="uploaddata">上传数据到服务器
		    </label>
			<button id="data_sure">确定</button>
			<h1>主机名设置</h1>
			<label for="hostname">主机名：</label>
     		<input type="text" name="hostname" id="hostname" value="detector1">
			<button id="hostname_sure">确定</button>
			<h1>偏好设置</h1>
			<label>
        		<input type="checkbox" name="beep_select" checked="checked" id="beep_select">蜂鸣
    		</label>
			<p>保存偏好只会在本次启动下更改，而写入偏好则会写入已经保存的偏好设置。</p>
			<button id="save_preferences">确定</button>
			<button class="write_preferences">写入偏好</button>-->
			<h1>显示设置</h1>
			<p>在用户中心里可以修改更多设置。</p>
			<a href="./center.php" data-ajax="false" rel="external">访问用户中心</a>
			<p>显示设置只对本电脑的本浏览器有效。</p>
			<label for="dotnumber">显示点数（0为显示所有点）：</label>
			<input type="range" name="dotnumber" id="dotnumber" min="0" max="1000" value="100">
			<label>
        		<input type="checkbox" name="dotdate_select" id="dotdate_select">日期限制
    		</label>
			<label for="dotdate">显示日期（0为显示所有点）：</label>
			<input type="text" name="dotdate" id="dotdate" class="date-input-inline" data-inline="true" data-role="date" data-role="date">
			<!--<label for="dotperiod">显示点间隔：</label>
    		<input type="range" name="dotperiod" id="dotperiod" min="0" max="20" value="1">-->
			<div class="ui-field-contain">
				<label for="datacal_sel">算法：</label>
				<select name="datacal_sel" id="datacal_sel">
					<option id="datacal_sel0" value="0">直接显示</option>
					<option id="datacal_sel1" value="1">从后到前平均</option>
					<option id="datacal_sel2" value="2">从前到后平均</option>
				</select>
			</div>
			<label for="autorefreshtime">自动刷新间隔（0为不自动刷新，单位：分钟）：</label>
			<input type="range" name="autorefreshtime" id="autorefreshtime" min="0" max="60" step="0.5" value="0">
			<button id="display_sure">确定</button>
			<script>
			$("#dotnumber").attr("value",maxdotnumber);
			$("#autorefreshtime").attr("value",autorefreshtime);
			$(document).ready(function(){
				$("#display_sure").click(function(){
					Cookies.set('dotnumber', $("#dotnumber").val(), { expires: 3650, path: '/' });
					//Cookies.set('dotperiod', $("#dotperiod").val(), { expires: 3650, path: '/' });
					Cookies.set('autorefreshtime', $("#autorefreshtime").val(), { expires: 3650, path: '/' });
					Cookies.set('datacal0', $("#datacal_sel").val(), { expires: 3650, path: '/' });
					location.reload(true);
				});
			});
			</script>
		</div>
	  </div>
	</div>
</div>
<script src="./js/chartscript.js"></script>
<script type="text/javascript">
var box_code = GetQueryString("box_code");
if(box_code){
	box_code = box_code.toUpperCase();
}else{
	box_code = "";
}
var box_password = GetQueryString("box_password");
if(box_password == null){
	box_password = "";
}
function show_loading(msgText,textVisible,theme,textonly,html){
	$.mobile.loading( "show", {
            text: msgText,
            textVisible: textVisible,
            theme: theme,
            textonly: textonly,
            html: html
    });
}
function hide_loading(msgText,textVisible,theme,textonly,html){
	$.mobile.loading( "hide" );
}

var mobile;
var data;
var dataarr = new Array();
show_loading("加载中……",true,"a",false,"");
var datacal = [Number(Cookies.get('datacal0'))];
if(isNaN(datacal[0])){
	datacal[0] = 1;
}
$("#datacal_sel"+String(datacal[0])).attr("selected","");
if(autorefreshtime){
	setInterval(autorefresh,autorefreshtime*1000*60);
}
var followed = false;
var boxstatustext_refresh = true;//When open the tab,refresh boxstatustext.
$.ajax({ 
	type:"GET", 
	url:"user.php", 
	dataType:"json", 
	data:{command:"info",box_code:box_code,box_password:box_password},
	cache:false,
	success:function(result){
		console.log(result);
		info = result;
		if(!box_code){
			alert("请输入盒子号码。");
			center();
			return;
		}
		if(info.result == "box_password"){
			prompt_return = prompt("请输入盒子访问密码：","");
			if(prompt_return == null){
				alert("返回用户中心。");
				center();
			}else{
				location.href = "./box.htm?box_code="+escape(box_code)+"&box_password="+escape(prompt_return);
			}
		}else if(info.result == "box_is_not_exist"){
			alert("盒子不存在。");
			center();
			return;
		}else if(info.result != "success"){
			if(info.result != "unlogined"){
				alert("获取信息状态："+info.result);
			}
		}
		followed = info.followed;
		if(followed){
			$("#follow").html("取消关注");
			$("#bname-text").val(info.box_bname);
		}else{
			$(".bname").hide();
			$("#bname-text").parent(".ui-input-text").hide();
		}
		if(info.login){
			$("#home-button").hide();
		}else{
			$("#center-button").hide();
			$("#follow").hide();
			$(".bname").hide();
			$("#bname-text").parent(".ui-input-text").hide();
		}
		if(info.box_bname && (info.box_bname != "")){
			$(".ui-title").text(info.box_bname+"状态显示");
		}else if(info.box_name){
			$(".ui-title").text(info.box_name+"状态显示");
		}
		$("#boxstatustext").text("盒子信息：\n盒子名称："+info.box_name+"\n盒子代码："+box_code+"\n盒子位置："+info.box_location+"\n盒子类型："+box_type_array[info.box_type]+"\n");
		boxstatustext_refresh = true;
	},
	failure:function (result) { 
		alert("获取信息出现问题。");
	}
});
$.ajax({ 
	type:"GET", 
	url:"user.php", 
	dataType:"json", 
	data:{command:"query",box_code:box_code,box_password:box_password},
	cache:false,
	success:getdatasuccess,
	failure:function (result) { 
		alert("获取数据出现问题。");
	}
});
function getdatasuccess(result){
	info2 = result;
	if(info2.result == "box_password"){
		//Simply ignore
	}else if(info2.result == "box_is_not_exist"){
	}else if(info2.result != "success"){
		if(info2.result != "unlogined"){
			alert("获取数据状态："+info2.result);
		}
	}
	data = info2.data;
	if(data.length == 0){
		if(confirm("盒子没有上传数据\n点击确定访问帮助。")){
			location.href="./guide.htm";
		}
	}
	datatype = new Array();
	dataarr = new Object();
	for(var i = 0;i < data.length;i++){
		for(k in data[i][0]){
			if(!dataarr[k]){
				dataarr[k] = new Array();
				datatype.push(k);
			}
			dataarr[k].push(new Array(data[i][0][k],data[i][1]));
		}
	}
	/*
	for(var i = 0;i < datatype.length;i++){
		var type = datatype[i];
		$("#navbar ul").append("<li><a number=\""+type+"\" class=\"navbar0item\" data-ajax=\"false\">"+sensor_name[type]+"</a></li>");
	}
	$("#navbar ul").navbar();*/
	/*for(var j = 0;j < datanumber;j++){
		if(datacal[0] == 1){
			for(var i = data[j].length-1;i >= 0;){
				do{
					dsp0 = data[j][i].split(",");
					i--;
					if(i < 0){
						break;
					}
				}while(isNaN(Number(dsp0[1])));
				do{
					if(i < 0){
						break;
					}
					dsp1 = orgdataarr[j][i].split(",");
					i--;
				}while(isNaN(Number(dsp1[1])));
				if(i < 0){
					dsp1 = dsp0;
				}
				do{
					if(i < 0){
						break;
					}
					dsp2 = orgdataarr[j][i].split(",");
					i--;
				}while(isNaN(Number(dsp2[1])));
				if(i < 0){
					dsp2 = dsp1.slice(0);
					dsp2[1] = String((Number(dsp0[1])+(Number(dsp1[1])))/2);
				}
				dataarr[j].splice(0,0,[(Number(dsp0[1])+Number(dsp1[1])+Number(dsp2[1]))/3,dsp2[3],dsp2[2]]);
				//console.log(orgdataarr);
				if((maxdotnumber != 0) && ((orgdataarr[j].length-1-i)/3 >= maxdotnumber)){
					break;
				}
			}
		}else if(datacal[0] == 2){
				for(var i = orgdataarr[j].length-1;i >= 2;){
				do{
					dsp0 = orgdataarr[j][i].split(",");
					i--;
				}while(isNaN(Number(dsp0[1])));
				if(i < 0){
					break;
				}
				do{
					dsp1 = orgdataarr[j][i].split(",");
					i--;
					if(i < 0){
						break;
					}
				}while(isNaN(Number(dsp1[1])));
				if(i < 0){
					dsp1 = dsp0;
					break;
				}
				do{
					dsp2 = orgdataarr[j][i].split(",");
					i--;
					if(i < 0){
						break;
					}
				}while(isNaN(Number(dsp2[1])));
				if(i < 0){
					dsp2 = dsp1.slice(0);
					dsp2[1] = String((Number(dsp0[1])+(Number(dsp1[1])))/2);
					break;
				}
				dataarr[j].splice(0,0,[(Number(dsp0[1])+Number(dsp1[1])+Number(dsp2[1]))/3,dsp2[3],dsp2[2]]);
				if((maxdotnumber != 0) && ((orgdataarr[j].length-1-i)/3 >= maxdotnumber)){
					break;
				}
			}
		}else{
			for(var i = orgdataarr[j].length-1;i >= 0;i--){
				dsp0 = orgdataarr[j][i].split(",");
				if(!isNaN(Number(dsp0[1]))){
					//dataarr[j].push([Number(dsp0[1]),dsp0[3],dsp0[2]]);
					dataarr[j].splice(0,0,[Number(dsp0[1]),dsp0[3],dsp0[2]]);
					//console.log(orgdataarr[j].length,i);
					if((maxdotnumber != 0) && ((orgdataarr[j].length-1-i) >= maxdotnumber)){
						break;
					}
				}
			}
		}
	}*/
	showcontainer(dataarr,-1);
	hide_loading();
	if(mobile){
		$(document).on("swiperight",swiperightHandler);
		$(document).on("swipeleft",swipeleftHandler);
	}
}
/*$(".navbar0item").click(function(e){
	n = Number($(this).attr("number"));
	console.log(n);
	showcontainer(dataarr,n);
});*/
function autorefresh(){
	location.reload();
}
/*function downloadFile(fileName, content){

	var aLink = document.createElement('a');
	var blob = new Blob([content]);
	var evt = document.createEvent("HTMLEvents");
	evt.click();
	//evt.initEvent("click", false, false);
	aLink.download = fileName;
	aLink.target = "_blank";
	aLink.href = URL.createObjectURL(blob);
	aLink.dispatchEvent(evt);
}*/
var option = 0;
function show_option(){
	if(option == 0){
		$(".show1").hide();
		$(".show2").show();
		if(boxstatustext_refresh){
			boxstatustext_refresh = false;
			$("#boxstatustext").textinput("refresh");
		}
		option = 1;
	}
}
function hide_option(){
	if(option == 1){
		$(".show2").hide();
		$(".show1").show();
		option = 0;
	}
}
function swiperightHandler(event){
	hide_option();
}
function swipeleftHandler(event){
	show_option();
}
$(document).ready(function(){
	var userAgent = navigator.userAgent.toLowerCase();
	if((userAgent.indexOf("android") != -1)||(userAgent.indexOf("ipad") != -1)||(userAgent.indexOf("iphone") != -1)||(userAgent.indexOf("ipod") != -1)){
		mobile = true;
		$("body").css("-webkit-user-select","none");
		$("body").css("-moz-user-select","none");
		$("body").css("-o-user-select","none");
		$("body").css("user-select","none");
		$(".ui-input-text").css("-webkit-user-select","true");
		$(".ui-input-text").css("-moz-user-select","true");
		$(".ui-input-text").css("-o-user-select","true");
		$(".ui-input-text").css("user-select","true");
	}else{
		mobile = false;
	}
	$(".show2").hide();
	$("#option-button").click(function(){
		show_option();
	});
	$("#save-button").click(function(){
		hide_option();
	});
	$("#home-button").click(function(){
		location.href="./";
	});
	$("#center-button").click(function(){
		location.href="./center.php";
	});
});
</script>
</body>